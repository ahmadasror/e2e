{
  "openapi": "3.0.3",
  "info": {
    "title": "E2E Dashboard API",
    "description": "API for submitting and querying E2E test results with multi-project support, event history, and detailed test cases.",
    "version": "4.0.0"
  },
  "servers": [
    {
      "url": "http://localhost:3000",
      "description": "Local development"
    }
  ],
  "paths": {
    "/api/projects": {
      "post": {
        "summary": "Register a new project",
        "tags": ["Projects"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["name"],
                "properties": {
                  "name": { "type": "string", "example": "manajemen-distrik" },
                  "description": { "type": "string", "example": "Sistem manajemen wilayah distrik" },
                  "repo_url": { "type": "string", "example": "https://github.com/org/manajemen-distrik" }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Project created",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Project" }
              }
            }
          },
          "400": { "description": "Missing required field: name" },
          "409": { "description": "Project already exists" }
        }
      },
      "get": {
        "summary": "List all projects",
        "tags": ["Projects"],
        "responses": {
          "200": {
            "description": "List of projects",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Project" }
                }
              }
            }
          }
        }
      }
    },
    "/api/projects/overview": {
      "get": {
        "summary": "List all projects with latest event stats",
        "tags": ["Projects"],
        "description": "Returns all projects including aggregated stats from their most recent event (passed, failed, skipped, total, last run time). Used by the dashboard landing page.",
        "responses": {
          "200": {
            "description": "List of projects with latest event stats",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/ProjectOverview" }
                }
              }
            }
          }
        }
      }
    },
    "/api/results": {
      "post": {
        "summary": "Submit test results as an execution event",
        "tags": ["Results"],
        "description": "Creates an event record grouping one or more test suite runs. Supports a single-suite format (backward compatible) or a multi-suite `suites` array.\n\nOptionally include a `description` to annotate the purpose of the test run (e.g. *\"E2E testing case untuk improvement management wilayah\"*).\n\nMaximum **15 events** per project — the oldest is automatically deleted when a 16th is posted.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "oneOf": [
                  { "$ref": "#/components/schemas/ResultsInputSingleSuite" },
                  { "$ref": "#/components/schemas/ResultsInputMultiSuite" }
                ]
              },
              "examples": {
                "single-suite": {
                  "summary": "Single suite (backward compatible)",
                  "value": {
                    "project_name": "manajemen-distrik",
                    "event_name": "Sanity Check",
                    "description": "Quick smoke test after deployment",
                    "trigger": "manual",
                    "suite_name": "01-login",
                    "total": 10,
                    "passed": 10,
                    "failed": 0,
                    "cases": []
                  }
                },
                "multi-suite": {
                  "summary": "Multiple suites in one event",
                  "value": {
                    "project_name": "manajemen-distrik",
                    "event_name": "E2E Run 2026-03-01",
                    "description": "E2E testing case untuk improvement management wilayah",
                    "trigger": "ci",
                    "suites": [
                      { "suite_name": "01-login", "total": 10, "passed": 10, "failed": 0, "cases": [] },
                      { "suite_name": "04-audit-trail", "total": 7, "passed": 7, "failed": 0, "cases": [] },
                      { "suite_name": "06-access-control", "total": 8, "passed": 7, "failed": 1, "cases": [
                        { "case_id": "6.1", "case_name": "Admin can view all districts", "module": "access", "type": "positive", "status": "pass", "duration_ms": 120 },
                        { "case_id": "6.2", "case_name": "Staff cannot delete district", "module": "access", "type": "negative", "status": "fail", "error_message": "Expected 403 but got 200", "duration_ms": 95 }
                      ]}
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Event and test run(s) created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": { "type": "integer", "description": "First run ID (backward compat)", "example": 1 },
                    "event_id": { "type": "integer", "example": 1 },
                    "run_ids": {
                      "type": "array",
                      "items": { "type": "integer" },
                      "example": [1, 2, 3]
                    }
                  }
                }
              }
            }
          },
          "400": { "description": "Missing required fields" },
          "500": { "description": "Internal server error" }
        }
      },
      "get": {
        "summary": "Get recent test runs",
        "tags": ["Results"],
        "parameters": [
          {
            "name": "limit",
            "in": "query",
            "schema": { "type": "integer", "default": 20, "maximum": 100 }
          },
          {
            "name": "project_id",
            "in": "query",
            "description": "Filter by project",
            "schema": { "type": "integer" }
          }
        ],
        "responses": {
          "200": {
            "description": "List of test runs",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/TestRun" }
                }
              }
            }
          }
        }
      }
    },
    "/api/results/{id}/cases": {
      "get": {
        "summary": "Get test cases for a specific run",
        "tags": ["Results"],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "responses": {
          "200": {
            "description": "List of test cases",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/TestCase" }
                }
              }
            }
          }
        }
      }
    },
    "/api/events": {
      "get": {
        "summary": "List events for a project (newest first, max 15)",
        "tags": ["Events"],
        "parameters": [
          {
            "name": "project_id",
            "in": "query",
            "required": true,
            "description": "Project ID to list events for",
            "schema": { "type": "integer" }
          }
        ],
        "responses": {
          "200": {
            "description": "List of events",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Event" }
                }
              }
            }
          },
          "400": { "description": "project_id is required" }
        }
      }
    },
    "/api/events/{id}": {
      "get": {
        "summary": "Get event detail with its test runs and cases",
        "tags": ["Events"],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "responses": {
          "200": {
            "description": "Event with runs and cases",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/EventDetail" }
              }
            }
          },
          "404": { "description": "Event not found" }
        }
      }
    },
    "/api/summary": {
      "get": {
        "summary": "Get aggregated stats",
        "tags": ["Stats"],
        "parameters": [
          {
            "name": "project_id",
            "in": "query",
            "description": "Filter by project",
            "schema": { "type": "integer" }
          }
        ],
        "responses": {
          "200": {
            "description": "Aggregated statistics",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Summary" }
              }
            }
          }
        }
      }
    },
    "/api/cases": {
      "get": {
        "summary": "Filter test cases globally",
        "tags": ["Results"],
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "description": "Filter by status",
            "schema": { "type": "string", "enum": ["pass", "fail", "skip"] }
          },
          {
            "name": "project_id",
            "in": "query",
            "description": "Filter by project",
            "schema": { "type": "integer" }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": { "type": "integer", "default": 50, "maximum": 200 }
          }
        ],
        "responses": {
          "200": {
            "description": "List of test cases",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/TestCase" }
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "Project": {
        "type": "object",
        "properties": {
          "id": { "type": "integer", "example": 1 },
          "name": { "type": "string", "example": "manajemen-distrik" },
          "description": { "type": "string", "example": "Sistem manajemen wilayah distrik" },
          "repo_url": { "type": "string", "example": "https://github.com/org/manajemen-distrik" },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "ProjectOverview": {
        "allOf": [
          { "$ref": "#/components/schemas/Project" },
          {
            "type": "object",
            "properties": {
              "latest_event_id": { "type": "integer", "nullable": true, "example": 50 },
              "latest_event_name": { "type": "string", "nullable": true, "example": "E2E Run 2026-03-01" },
              "latest_trigger": { "type": "string", "nullable": true, "example": "manual" },
              "latest_total": { "type": "integer", "nullable": true, "example": 53 },
              "latest_passed": { "type": "integer", "nullable": true, "example": 52 },
              "latest_failed": { "type": "integer", "nullable": true, "example": 1 },
              "latest_skipped": { "type": "integer", "nullable": true, "example": 0 },
              "latest_event_at": { "type": "string", "format": "date-time", "nullable": true }
            }
          }
        ]
      },
      "Event": {
        "type": "object",
        "properties": {
          "id": { "type": "integer", "example": 50 },
          "project_id": { "type": "integer", "example": 3 },
          "project_name": { "type": "string", "example": "manajemen-distrik" },
          "event_name": { "type": "string", "example": "E2E Run 2026-03-01" },
          "description": { "type": "string", "nullable": true, "example": "E2E testing case untuk improvement management wilayah" },
          "trigger": { "type": "string", "example": "manual", "enum": ["manual", "ci", "scheduled"] },
          "total": { "type": "integer", "example": 53 },
          "passed": { "type": "integer", "example": 52 },
          "failed": { "type": "integer", "example": 1 },
          "skipped": { "type": "integer", "example": 0 },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "EventDetail": {
        "allOf": [
          { "$ref": "#/components/schemas/Event" },
          {
            "type": "object",
            "properties": {
              "runs": {
                "type": "array",
                "items": { "$ref": "#/components/schemas/TestRun" }
              },
              "cases": {
                "type": "array",
                "items": { "$ref": "#/components/schemas/TestCase" }
              }
            }
          }
        ]
      },
      "TestRun": {
        "type": "object",
        "properties": {
          "id": { "type": "integer", "example": 54 },
          "project_id": { "type": "integer", "example": 3 },
          "project_name": { "type": "string", "example": "manajemen-distrik" },
          "event_id": { "type": "integer", "example": 50 },
          "suite_name": { "type": "string", "example": "06-access-control" },
          "total": { "type": "integer", "example": 8 },
          "passed": { "type": "integer", "example": 7 },
          "failed": { "type": "integer", "example": 1 },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "ResultsInputSingleSuite": {
        "type": "object",
        "required": ["suite_name", "total", "passed", "failed"],
        "properties": {
          "suite_name": { "type": "string", "example": "01-login" },
          "total": { "type": "integer", "example": 10 },
          "passed": { "type": "integer", "example": 10 },
          "failed": { "type": "integer", "example": 0 },
          "project_id": { "type": "integer", "description": "Existing project ID" },
          "project_name": { "type": "string", "description": "Project name — auto-creates project if not exists", "example": "manajemen-distrik" },
          "event_name": { "type": "string", "example": "Sanity Check", "default": "Test Run" },
          "description": { "type": "string", "description": "Short description of what this test run covers", "example": "Quick smoke test after deployment" },
          "trigger": { "type": "string", "example": "manual", "default": "manual", "enum": ["manual", "ci", "scheduled"] },
          "cases": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/TestCaseInput" }
          }
        }
      },
      "ResultsInputMultiSuite": {
        "type": "object",
        "required": ["suites"],
        "properties": {
          "project_id": { "type": "integer" },
          "project_name": { "type": "string", "description": "Project name — auto-creates project if not exists", "example": "manajemen-distrik" },
          "event_name": { "type": "string", "example": "E2E Run 2026-03-01", "default": "Test Run" },
          "description": { "type": "string", "description": "Short description of what this test run covers", "example": "E2E testing case untuk improvement management wilayah" },
          "trigger": { "type": "string", "example": "ci", "default": "manual", "enum": ["manual", "ci", "scheduled"] },
          "suites": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["suite_name", "total", "passed", "failed"],
              "properties": {
                "suite_name": { "type": "string", "example": "06-access-control" },
                "total": { "type": "integer", "example": 8 },
                "passed": { "type": "integer", "example": 7 },
                "failed": { "type": "integer", "example": 1 },
                "cases": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/TestCaseInput" }
                }
              }
            }
          }
        }
      },
      "TestCaseInput": {
        "type": "object",
        "required": ["case_name", "status"],
        "properties": {
          "case_id": { "type": "string", "example": "6.1" },
          "case_name": { "type": "string", "example": "Admin can view all districts" },
          "description": { "type": "string", "example": "Verifies admin has read access to all district data" },
          "module": { "type": "string", "example": "access-control" },
          "type": { "type": "string", "enum": ["positive", "negative"], "example": "positive" },
          "status": { "type": "string", "enum": ["pass", "fail", "skip"], "example": "pass" },
          "error_message": { "type": "string", "example": "Expected 403 but got 200" },
          "duration_ms": { "type": "integer", "example": 120 }
        }
      },
      "TestCase": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "run_id": { "type": "integer" },
          "case_id": { "type": "string", "example": "6.1" },
          "case_name": { "type": "string", "example": "Admin can view all districts" },
          "description": { "type": "string" },
          "module": { "type": "string", "example": "access-control" },
          "type": { "type": "string", "enum": ["positive", "negative"] },
          "status": { "type": "string", "enum": ["pass", "fail", "skip"] },
          "error_message": { "type": "string" },
          "duration_ms": { "type": "integer" },
          "suite_name": { "type": "string" },
          "project_id": { "type": "integer" },
          "project_name": { "type": "string" }
        }
      },
      "Summary": {
        "type": "object",
        "properties": {
          "run_count": { "type": "string", "example": "15" },
          "total_tests": { "type": "string", "example": "212" },
          "total_passed": { "type": "string", "example": "208" },
          "total_failed": { "type": "string", "example": "4" }
        }
      }
    }
  }
}
